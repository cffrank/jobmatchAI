rules_version = '2';

// Firebase Storage Security Rules for JobMatch AI
service firebase.storage {
  match /b/{bucket}/o {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Helper function to validate image file types
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }

    // Helper function to validate document file types
    function isDocument() {
      return request.resource.contentType.matches('application/pdf')
          || request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.wordprocessingml.document')
          || request.resource.contentType.matches('text/plain');
    }

    // Helper function to validate file size (max 5MB for documents, 2MB for images)
    function isValidSize(maxSizeInMB) {
      return request.resource.size < maxSizeInMB * 1024 * 1024;
    }

    // User-specific storage
    match /users/{userId}/{allPaths=**} {
      // Users can only access their own files
      allow read, write: if isAuthenticated() && isOwner(userId);

      // Profile photos
      match /profile/{imageFile} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && isOwner(userId) && isImage() && isValidSize(2);
      }

      // Resumes (PDF, DOCX, TXT)
      match /resumes/{resumeId}/{fileName} {
        allow read, write: if isAuthenticated() && isOwner(userId) && isDocument() && isValidSize(5);
      }

      // Cover letters (PDF)
      match /cover-letters/{applicationId}/{fileName} {
        allow read, write: if isAuthenticated() && isOwner(userId) && isDocument() && isValidSize(5);
      }

      // Invoices (PDF, generated by Cloud Functions)
      match /invoices/{invoiceFile} {
        allow read: if isAuthenticated() && isOwner(userId);
        // Only Cloud Functions can write invoices
        allow write: if false;
      }

      // Export files (ZIP, generated by user)
      match /exports/{exportFile} {
        allow read, write: if isAuthenticated() && isOwner(userId) && isValidSize(10);
      }
    }
  }
}
