name: Deploy Backend to Railway

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend-railway.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          cd backend
          railway up --service backend --detach

      - name: Set Environment Variables
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          SENDGRID_FROM_EMAIL: ${{ secrets.SENDGRID_FROM_EMAIL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          LINKEDIN_CLIENT_ID: ${{ secrets.LINKEDIN_CLIENT_ID }}
          LINKEDIN_CLIENT_SECRET: ${{ secrets.LINKEDIN_CLIENT_SECRET }}
          LINKEDIN_REDIRECT_URI: ${{ secrets.LINKEDIN_REDIRECT_URI }}
          APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
        run: |
          cd backend

          # Supabase Configuration
          railway variables set SUPABASE_URL="$SUPABASE_URL" --service backend
          railway variables set SUPABASE_ANON_KEY="$SUPABASE_ANON_KEY" --service backend
          railway variables set SUPABASE_SERVICE_ROLE_KEY="$SUPABASE_SERVICE_ROLE_KEY" --service backend

          # OpenAI Configuration
          railway variables set OPENAI_API_KEY="$OPENAI_API_KEY" --service backend

          # SendGrid Configuration
          railway variables set SENDGRID_API_KEY="$SENDGRID_API_KEY" --service backend
          railway variables set SENDGRID_FROM_EMAIL="$SENDGRID_FROM_EMAIL" --service backend

          # Application Configuration
          railway variables set NODE_ENV="production" --service backend
          railway variables set PORT="3000" --service backend
          railway variables set JWT_SECRET="$JWT_SECRET" --service backend
          railway variables set APP_URL="$FRONTEND_URL" --service backend
          railway variables set STORAGE_BUCKET="exports" --service backend

          # LinkedIn OAuth (Optional)
          if [ -n "$LINKEDIN_CLIENT_ID" ]; then
            railway variables set LINKEDIN_CLIENT_ID="$LINKEDIN_CLIENT_ID" --service backend
            railway variables set LINKEDIN_CLIENT_SECRET="$LINKEDIN_CLIENT_SECRET" --service backend
            railway variables set LINKEDIN_REDIRECT_URI="$LINKEDIN_REDIRECT_URI" --service backend
          fi

          # Apify (Optional)
          if [ -n "$APIFY_API_TOKEN" ]; then
            railway variables set APIFY_API_TOKEN="$APIFY_API_TOKEN" --service backend
          fi

      - name: Wait for Deployment
        run: sleep 30

      - name: Health Check
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          # Get backend URL from Railway
          cd backend
          BACKEND_URL=$(railway status --service backend --json | jq -r '.deployments[0].url')

          if [ -z "$BACKEND_URL" ]; then
            echo "Failed to get backend URL"
            exit 1
          fi

          echo "Testing health endpoint: $BACKEND_URL/health"

          # Retry health check up to 10 times
          for i in {1..10}; do
            if curl -f -s "$BACKEND_URL/health" > /dev/null; then
              echo "âœ“ Health check passed!"
              curl -s "$BACKEND_URL/health" | jq '.'
              exit 0
            fi
            echo "Health check attempt $i failed, retrying in 10s..."
            sleep 10
          done

          echo "âœ— Health check failed after 10 attempts"
          exit 1

      - name: Output Backend URL
        if: success()
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          cd backend
          BACKEND_URL=$(railway status --service backend --json | jq -r '.deployments[0].url')
          echo "ðŸš€ Backend deployed successfully!"
          echo "Backend URL: $BACKEND_URL"
          echo "Health check: $BACKEND_URL/health"
          echo ""
          echo "Next steps:"
          echo "1. Update frontend VITE_BACKEND_URL to: $BACKEND_URL"
          echo "2. Update LinkedIn OAuth redirect URI (if configured)"
          echo "3. Test API endpoints"
