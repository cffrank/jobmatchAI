name: Deploy Backend to Railway

on:
  push:
    branches:
      - main      # → production environment
      - staging   # → staging environment
      - develop   # → development environment
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend-railway.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - production
          - staging
          - development

jobs:
  deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine deployment environment
        id: env-setup
        run: |
          # Determine environment based on branch or manual input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV_NAME="${{ github.event.inputs.environment }}"
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          else
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
            case "$BRANCH_NAME" in
              main)
                ENV_NAME="production"
                ;;
              staging)
                ENV_NAME="staging"
                ;;
              develop)
                ENV_NAME="development"
                ;;
              *)
                echo "Error: Unknown branch $BRANCH_NAME"
                exit 1
                ;;
            esac
          fi

          echo "environment=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Deploying branch '$BRANCH_NAME' to environment '$ENV_NAME'"

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN_PRODUCTION: ${{ secrets.RAILWAY_TOKEN_PRODUCTION }}
          RAILWAY_TOKEN_STAGING: ${{ secrets.RAILWAY_TOKEN_STAGING }}
          RAILWAY_TOKEN_DEVELOPMENT: ${{ secrets.RAILWAY_TOKEN_DEVELOPMENT }}
          ENVIRONMENT: ${{ steps.env-setup.outputs.environment }}
        run: |
          cd backend
          echo "Deploying to Railway environment: $ENVIRONMENT"

          # Select the appropriate token for the environment
          case "$ENVIRONMENT" in
            production)
              export RAILWAY_TOKEN="$RAILWAY_TOKEN_PRODUCTION"
              ;;
            staging)
              export RAILWAY_TOKEN="$RAILWAY_TOKEN_STAGING"
              ;;
            development)
              export RAILWAY_TOKEN="$RAILWAY_TOKEN_DEVELOPMENT"
              ;;
            *)
              echo "Error: Unknown environment $ENVIRONMENT"
              exit 1
              ;;
          esac

          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "Error: RAILWAY_TOKEN_${ENVIRONMENT^^} secret not configured"
            echo "Please add the Railway project token for the $ENVIRONMENT environment to GitHub secrets"
            exit 1
          fi

          # Determine service name based on environment
          # Development uses 'backend1', staging/production use 'backend'
          case "$ENVIRONMENT" in
            development)
              SERVICE_NAME="backend1"
              ;;
            *)
              SERVICE_NAME="backend"
              ;;
          esac

          echo "Deploying to service: $SERVICE_NAME"
          railway up --service "$SERVICE_NAME" --environment "$ENVIRONMENT" --detach

      # IMPORTANT: Environment variables are pre-configured in Railway dashboard
      # See: docs/RAILWAY-MULTI-ENVIRONMENT-SETUP.md for complete list of variables
      # They are NOT set via CLI to avoid triggering unnecessary redeploys
      # This approach:
      # - Eliminates 1.5-2 minute redeploy cycles
      # - Reduces total deployment time from 3-5 min to 2-3 min
      # - Follows Railway best practices for environment configuration
      # - Variables are set once and persist across all deployments

      - name: Wait for Deployment Stability
        run: sleep 15

      - name: Health Check
        id: health-check
        env:
          RAILWAY_TOKEN_PRODUCTION: ${{ secrets.RAILWAY_TOKEN_PRODUCTION }}
          RAILWAY_TOKEN_STAGING: ${{ secrets.RAILWAY_TOKEN_STAGING }}
          RAILWAY_TOKEN_DEVELOPMENT: ${{ secrets.RAILWAY_TOKEN_DEVELOPMENT }}
          ENVIRONMENT: ${{ steps.env-setup.outputs.environment }}
        run: |
          cd backend

          # Select the appropriate token for the environment
          case "$ENVIRONMENT" in
            production)
              export RAILWAY_TOKEN="$RAILWAY_TOKEN_PRODUCTION"
              ;;
            staging)
              export RAILWAY_TOKEN="$RAILWAY_TOKEN_STAGING"
              ;;
            development)
              export RAILWAY_TOKEN="$RAILWAY_TOKEN_DEVELOPMENT"
              ;;
          esac

          # Get backend URL from Railway for specific environment
          # Use railway domain command which works with the current CLI version
          BACKEND_URL=$(railway domain 2>/dev/null || echo "")

          # Fallback: If domain command doesn't work, try status without service flag
          if [ -z "$BACKEND_URL" ] || [ "$BACKEND_URL" == "null" ]; then
            echo "Trying alternative method to get deployment URL..."
            BACKEND_URL=$(railway status --json 2>/dev/null | jq -r '.deployments[0].url // empty' || echo "")
          fi

          if [ -z "$BACKEND_URL" ] || [ "$BACKEND_URL" == "null" ]; then
            echo "⚠️  Could not retrieve deployment URL automatically"
            echo "Check Railway dashboard for deployment status:"
            echo "https://railway.app/project"
            echo "backend_url=unknown" >> $GITHUB_OUTPUT
            exit 0  # Don't fail the deployment, just skip health check
          fi

          echo "Testing health endpoint: $BACKEND_URL/health"
          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT

          # Retry health check up to 5 times
          for i in {1..5}; do
            if curl -f -s "$BACKEND_URL/health" > /dev/null; then
              echo "✅ Health check passed on attempt $i"
              curl -s "$BACKEND_URL/health" | jq '.'
              exit 0
            fi
            echo "⏳ Health check attempt $i/5 failed, retrying in 10s..."
            sleep 10
          done

          echo "⚠️  Health check failed after 5 attempts (50 seconds)"
          echo "This may be normal for the first deployment or if the service is still building."
          echo "Check Railway dashboard: https://railway.app/project"
          exit 0  # Don't fail - deployment may still be building

      # NOTE: CORS validation is handled by the main Test Suite workflow
      # which runs comprehensive E2E tests (including CORS) against localhost
      # before any code is pushed. Railway auto-deploys from GitHub when tests pass.

      - name: Deployment Summary
        if: success()
        env:
          ENVIRONMENT: ${{ steps.env-setup.outputs.environment }}
          BRANCH: ${{ steps.env-setup.outputs.branch }}
          BACKEND_URL: ${{ steps.health-check.outputs.backend_url }}
        run: |
          echo "=========================================="
          echo "Deployment Successful!"
          echo "=========================================="
          echo "Branch: $BRANCH"
          echo "Environment: $ENVIRONMENT"
          echo "Backend URL: $BACKEND_URL"
          echo "Health Endpoint: $BACKEND_URL/health"
          echo "=========================================="
          echo ""
          echo "Next Steps:"
          case "$ENVIRONMENT" in
            production)
              echo "✓ Production is now live with latest changes"
              echo "- Monitor Railway dashboard for any issues"
              echo "- Check error tracking (if configured)"
              echo "- Verify critical user flows"
              ;;
            staging)
              echo "✓ Staging environment updated"
              echo "- Run QA test suite against staging"
              echo "- Verify all features work as expected"
              echo "- If tests pass, create PR: staging → main"
              ;;
            development)
              echo "✓ Development environment updated"
              echo "- Test integrated features in deployed environment"
              echo "- Verify API endpoints work correctly"
              echo "- If stable, create PR: develop → staging"
              ;;
          esac

      - name: Notify on Failure
        if: failure()
        env:
          ENVIRONMENT: ${{ steps.env-setup.outputs.environment }}
          BRANCH: ${{ steps.env-setup.outputs.branch }}
        run: |
          echo "=========================================="
          echo "Deployment Failed!"
          echo "=========================================="
          echo "Branch: $BRANCH"
          echo "Environment: $ENVIRONMENT"
          echo ""
          echo "Troubleshooting Steps:"
          echo "1. Check Railway dashboard for deployment logs"
          echo "2. Verify environment variables are set correctly"
          echo "3. Check backend build logs for errors"
          echo "4. Verify health endpoint is accessible"
          echo ""
          echo "Railway Dashboard: https://railway.app/project"
