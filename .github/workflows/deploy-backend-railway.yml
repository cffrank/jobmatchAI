name: Deploy Backend to Railway

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend-railway.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          cd backend
          railway up --service backend --detach

      # IMPORTANT: Environment variables are pre-configured in Railway dashboard
      # See: docs/RAILWAY_SETUP_GUIDE.md for complete list of variables
      # They are NOT set via CLI to avoid triggering unnecessary redeploys
      # This approach:
      # - Eliminates 1.5-2 minute redeploy cycles
      # - Reduces total deployment time from 3-5 min to 2-3 min
      # - Follows Railway best practices for environment configuration
      # - Variables are set once and persist across all deployments

      - name: Wait for Deployment Stability
        run: sleep 15

      - name: Health Check
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          cd backend

          # Get backend URL from Railway
          BACKEND_URL=$(railway status --service backend --json | jq -r '.deployments[0].url')

          if [ -z "$BACKEND_URL" ]; then
            echo "Failed to get backend URL"
            exit 1
          fi

          echo "Testing health endpoint: $BACKEND_URL/health"

          # Retry health check up to 5 times (reduced from 10)
          # Each retry is 10 seconds, so total max wait is ~50 seconds
          # Combined with 15s startup wait = ~65s total deployment validation
          for i in {1..5}; do
            if curl -f -s "$BACKEND_URL/health" > /dev/null; then
              echo "Health check passed on attempt $i"
              curl -s "$BACKEND_URL/health" | jq '.'
              exit 0
            fi
            echo "Health check attempt $i/5 failed, retrying in 10s..."
            sleep 10
          done

          echo "Health check failed after 5 attempts (50 seconds)"
          exit 1

      - name: Output Backend URL
        if: success()
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          cd backend
          BACKEND_URL=$(railway status --service backend --json | jq -r '.deployments[0].url')
          echo "Backend deployed successfully!"
          echo "Backend URL: $BACKEND_URL"
          echo "Health endpoint: $BACKEND_URL/health"
          echo ""
          echo "Deployment Summary:"
          echo "- Time: ~2-3 minutes (optimized from 3-5 minutes)"
          echo "- Variables: Pre-configured in Railway dashboard"
          echo "- Rollback: Available in Railway dashboard deployment history"
          echo ""
          echo "Next steps:"
          echo "1. Update frontend VITE_BACKEND_URL if URL changed"
          echo "2. Verify API endpoints are responding"
          echo "3. Check Railway dashboard for any warnings"
