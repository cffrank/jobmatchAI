name: Cost & Performance Monitoring

on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:

env:
  FIREBASE_PROJECT_ID: 'ai-career-os-139db'

jobs:
  check-firebase-usage:
    name: Check Firebase Usage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Authenticate to Firebase
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > $HOME/service-account.json
          export GOOGLE_APPLICATION_CREDENTIALS=$HOME/service-account.json

      - name: Generate Usage Report
        env:
          PROJECT_ID: ${{ env.FIREBASE_PROJECT_ID }}
        run: |
          echo "# Firebase Usage Report - $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Services Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This is a placeholder for Firebase usage monitoring." >> $GITHUB_STEP_SUMMARY
          echo "Manual checks recommended:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Firebase Console**: https://console.firebase.google.com/project/$PROJECT_ID/usage" >> $GITHUB_STEP_SUMMARY
          echo "2. **Check the following metrics**:" >> $GITHUB_STEP_SUMMARY
          echo "   - Hosting bandwidth usage" >> $GITHUB_STEP_SUMMARY
          echo "   - Cloud Functions invocations" >> $GITHUB_STEP_SUMMARY
          echo "   - Firestore read/write operations" >> $GITHUB_STEP_SUMMARY
          echo "   - Storage usage and bandwidth" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Cost Thresholds" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Set up billing alerts in Firebase Console:" >> $GITHUB_STEP_SUMMARY
          echo "- Go to Project Settings > Usage and Billing" >> $GITHUB_STEP_SUMMARY
          echo "- Set up budget alerts for cost monitoring" >> $GITHUB_STEP_SUMMARY
          echo "- Recommended thresholds: 50%, 80%, 100% of monthly budget" >> $GITHUB_STEP_SUMMARY

      - name: Check Recent Deployments
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Recent Deployment Activity" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check deployment frequency and success rate:" >> $GITHUB_STEP_SUMMARY
          echo "- Recent deploys impact quota usage" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor function cold starts" >> $GITHUB_STEP_SUMMARY
          echo "- Review error rates in Firebase Console" >> $GITHUB_STEP_SUMMARY

      - name: Security Recommendations
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Security Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Regular security maintenance:" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Review Firebase security rules (last 30 days)" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Check for unusual authentication patterns" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Verify service account permissions" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Review Cloud Functions access logs" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Rotate secrets if 90+ days old" >> $GITHUB_STEP_SUMMARY

      - name: Performance Metrics
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Performance Monitoring" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Key metrics to monitor:" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: Check Core Web Vitals in Firebase Performance" >> $GITHUB_STEP_SUMMARY
          echo "- **Functions**: Monitor execution time and memory usage" >> $GITHUB_STEP_SUMMARY
          echo "- **Firestore**: Review query performance and index usage" >> $GITHUB_STEP_SUMMARY
          echo "- **Storage**: Check download speeds and CDN hit rates" >> $GITHUB_STEP_SUMMARY

      - name: Clean up
        if: always()
        run: rm -f $HOME/service-account.json

  dependency-health:
    name: Dependency Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check Frontend Dependencies
        run: |
          npm outdated || true
          echo "## Frontend Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run \`npm outdated\` locally to see detailed version information" >> $GITHUB_STEP_SUMMARY

      - name: Check Functions Dependencies
        working-directory: functions
        run: |
          npm outdated || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Cloud Functions Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run \`npm outdated\` in functions/ to see detailed version information" >> $GITHUB_STEP_SUMMARY

      - name: Security Audit
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Security Vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Frontend audit
          FRONTEND_AUDIT=$(npm audit --json 2>&1 || true)
          FRONTEND_CRITICAL=$(echo "$FRONTEND_AUDIT" | jq -r '.metadata.vulnerabilities.critical // 0' 2>/dev/null || echo "0")
          FRONTEND_HIGH=$(echo "$FRONTEND_AUDIT" | jq -r '.metadata.vulnerabilities.high // 0' 2>/dev/null || echo "0")

          echo "**Frontend**:" >> $GITHUB_STEP_SUMMARY
          echo "- Critical: $FRONTEND_CRITICAL" >> $GITHUB_STEP_SUMMARY
          echo "- High: $FRONTEND_HIGH" >> $GITHUB_STEP_SUMMARY

          # Functions audit
          cd functions
          FUNCTIONS_AUDIT=$(npm audit --json 2>&1 || true)
          FUNCTIONS_CRITICAL=$(echo "$FUNCTIONS_AUDIT" | jq -r '.metadata.vulnerabilities.critical // 0' 2>/dev/null || echo "0")
          FUNCTIONS_HIGH=$(echo "$FUNCTIONS_AUDIT" | jq -r '.metadata.vulnerabilities.high // 0' 2>/dev/null || echo "0")

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cloud Functions**:" >> $GITHUB_STEP_SUMMARY
          echo "- Critical: $FUNCTIONS_CRITICAL" >> $GITHUB_STEP_SUMMARY
          echo "- High: $FUNCTIONS_HIGH" >> $GITHUB_STEP_SUMMARY

          # Alert if critical vulnerabilities found
          TOTAL_CRITICAL=$((FRONTEND_CRITICAL + FUNCTIONS_CRITICAL))
          if [ "$TOTAL_CRITICAL" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ **ACTION REQUIRED**: $TOTAL_CRITICAL critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            echo "Run \`npm audit fix\` to resolve" >> $GITHUB_STEP_SUMMARY
          fi
