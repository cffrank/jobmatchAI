name: Deploy to Cloudflare (GitHub Actions)

on:
  push:
    branches:
      - develop      # Deploy to development
      - staging      # Deploy to staging
      - main         # Deploy to production
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - development
          - staging
          - production

env:
  NODE_VERSION: '22.x'

permissions:
  contents: read
  deployments: write

concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  # Lint before any other job
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Run frontend linter
        run: npm run lint

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Run backend linter
        working-directory: backend
        run: npm run lint

  # Run all tests before deploying
  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # Frontend tests
      - name: Install frontend dependencies
        run: npm ci

      - name: Run frontend type check
        run: npm run build:check

      - name: Run frontend linter
        run: npm run lint

      # Backend tests
      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Run backend type check
        working-directory: backend
        run: npm run typecheck

      - name: Run backend linter
        working-directory: backend
        run: npm run lint

      - name: Run backend unit tests
        working-directory: backend
        run: npm run test:unit
        env:
          NODE_ENV: test
          SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'http://localhost:54321' }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || 'test-key' }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || 'test-key' }}

      # Integration tests disabled during Cloudflare migration
      # These test old Supabase Postgres database (being replaced with D1)
      # Will re-enable with D1-based tests once migration is complete
      # - name: Run backend integration tests
      #   working-directory: backend
      #   run: npm run test:integration
      #   env:
      #     NODE_ENV: test
      #     SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'http://localhost:54321' }}
      #     SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || 'test-key' }}
      #     SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || 'test-key' }}

  # Run database migrations
  # Note: Infrastructure (KV, R2, Vectorize, AI Gateway) is provisioned manually
  # Only D1 database schema migrations run on each deployment
  run-migrations:
    name: Run D1 Database Migrations
    runs-on: ubuntu-latest
    needs: run-tests
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Determine environment
        id: env
        env:
          EVENT_NAME: ${{ github.event_name }}
          WORKFLOW_INPUT_ENV: ${{ github.event.inputs.environment }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          if [ "$EVENT_NAME" == "workflow_dispatch" ]; then
            ENV="$WORKFLOW_INPUT_ENV"
          else
            case "$BRANCH_NAME" in
              develop)
                ENV="development"
                ;;
              staging)
                ENV="staging"
                ;;
              main)
                ENV="production"
                ;;
              *)
                echo "Unknown branch: $BRANCH_NAME"
                exit 1
                ;;
            esac
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT

      - name: Install wrangler
        working-directory: workers
        run: npm ci

      - name: Skip Infrastructure Provisioning
        env:
          DEPLOY_ENV: ${{ steps.env.outputs.environment }}
        run: |
          echo "‚ÑπÔ∏è  Skipping infrastructure provisioning for ${DEPLOY_ENV}"
          echo ""
          echo "Infrastructure (KV, R2, Vectorize, AI Gateway) is provisioned manually."
          echo "This deployment will only run D1 database migrations."
          echo ""
          echo "Infrastructure already exists:"
          echo "  ‚úÖ KV Namespaces: JOB_ANALYSIS_CACHE, SESSIONS, RATE_LIMITS, OAUTH_STATES, EMBEDDINGS_CACHE, AI_GATEWAY_CACHE"
          echo "  ‚úÖ R2 Buckets: avatars, resumes, exports"
          echo "  ‚úÖ Vectorize Index: 768-dimensional vectors with cosine similarity"
          echo "  ‚úÖ AI Gateway: jobmatch-ai-gateway-dev"
          echo "  ‚úÖ Workers AI: Available automatically"

      - name: Run D1 Migrations
        working-directory: workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DEPLOY_ENV: ${{ steps.env.outputs.environment }}
        run: |
          echo "üóÑÔ∏è  Running D1 Migrations for ${DEPLOY_ENV}..."

          # Check if migrations directory exists
          if [ ! -d "migrations" ]; then
            echo "‚ö†Ô∏è  No migrations directory found, skipping..."
            exit 0
          fi

          # Count migration files
          MIGRATION_COUNT=$(find migrations -name "*.sql" 2>/dev/null | wc -l)

          if [ "$MIGRATION_COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è  No migration files found, skipping..."
            exit 0
          fi

          echo "üìã Found $MIGRATION_COUNT migration file(s)"

          # Step 1: Validate migration files (sequential numbering, no gaps)
          echo ""
          echo "üîç Validating migration files..."
          MIGRATION_FILES=$(find migrations -name "*.sql" | sort)
          EXPECTED_NUM=1
          VALIDATION_FAILED=0

          for file in $MIGRATION_FILES; do
            BASENAME=$(basename "$file")
            # Extract number from filename (e.g., "0001" from "0001_description.sql")
            FILE_NUM=$(echo "$BASENAME" | grep -oP '^\d+' || echo "0")

            if [ "$FILE_NUM" != "$(printf '%04d' $EXPECTED_NUM)" ]; then
              echo "‚ùå Migration numbering error: Expected $EXPECTED_NUM, found $FILE_NUM in $BASENAME"
              VALIDATION_FAILED=1
            fi

            EXPECTED_NUM=$((EXPECTED_NUM + 1))
          done

          if [ "$VALIDATION_FAILED" -eq 1 ]; then
            echo ""
            echo "‚ùå Migration validation failed - fix numbering before deploying"
            exit 1
          fi

          echo "‚úÖ Migration files validated successfully"

          # Step 2: Check D1 database connectivity (test if D1 is authorized)
          echo ""
          echo "üîå Testing D1 database connectivity..."

          # Try a simple query to test connectivity
          TEST_RESULT=$(npx wrangler d1 execute DB \
            --env "$DEPLOY_ENV" \
            --remote \
            --command "SELECT 1 as test;" 2>&1) || {

            # Check if it's an authorization error
            if echo "$TEST_RESULT" | grep -q -E "(not authorized|not entitled|requires|upgrade)"; then
              echo "‚ö†Ô∏è  D1 is not authorized on this account"
              echo "‚ö†Ô∏è  Skipping migrations - D1 needs to be enabled in Cloudflare dashboard"
              echo ""
              echo "To enable D1:"
              echo "  1. Go to https://dash.cloudflare.com/"
              echo "  2. Select your account"
              echo "  3. Navigate to Workers & Pages ‚Üí D1"
              echo "  4. Enable D1 if prompted"
              exit 0
            else
              # Real connection error
              echo "‚ùå D1 connection test failed:"
              echo "$TEST_RESULT"
              echo ""
              echo "This is a real error - failing the build"
              exit 1
            fi
          }

          echo "‚úÖ D1 database connection successful"

          # Step 3: Preview pending migrations
          echo ""
          echo "üìã Migration Preview:"
          echo "===================="

          # List migrations (wrangler doesn't have a preview command, so we'll list files)
          echo "Migrations to apply:"
          for file in $MIGRATION_FILES; do
            echo "  - $(basename $file)"
          done
          echo ""

          # Step 4: Apply migrations
          echo "‚öôÔ∏è  Applying migrations to ${DEPLOY_ENV}..."
          echo ""

          MIGRATION_OUTPUT=$(npx wrangler d1 migrations apply DB \
            --env "$DEPLOY_ENV" \
            --remote 2>&1)

          MIGRATION_EXIT_CODE=$?

          # Show output
          echo "$MIGRATION_OUTPUT"
          echo ""

          # Check exit code
          if [ $MIGRATION_EXIT_CODE -ne 0 ]; then
            # Migration failed - check if it's because migrations already applied
            if echo "$MIGRATION_OUTPUT" | grep -q -E "(already applied|no migrations to apply|up to date)"; then
              echo "‚ÑπÔ∏è  Migrations already applied, database is up to date"
            else
              echo "‚ùå Migration failed with exit code: $MIGRATION_EXIT_CODE"
              echo ""
              echo "Common causes:"
              echo "  - SQL syntax error in migration file"
              echo "  - Foreign key constraint violation"
              echo "  - Duplicate migration (applied manually but not tracked)"
              echo "  - Database lock/timeout"
              echo ""
              echo "Fix the issue and re-run the deployment"
              exit 1
            fi
          fi

          # Step 5: Show migration history
          echo ""
          echo "üìú Migration History:"
          echo "===================="

          # Query migrations table to show what's been applied
          npx wrangler d1 execute DB \
            --env "$DEPLOY_ENV" \
            --remote \
            --command "SELECT name, applied_at FROM d1_migrations ORDER BY id;" 2>&1 || {
            echo "‚ö†Ô∏è  Could not retrieve migration history (this is non-critical)"
          }

          echo ""
          echo "‚úÖ D1 migrations completed successfully"

      - name: Slack Notification - D1 Migration Success
        if: success()
        continue-on-error: true
        working-directory: workers
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DEPLOY_ENV: ${{ steps.env.outputs.environment }}
          BRANCH_NAME: ${{ github.ref_name }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          # Skip if SLACK_WEBHOOK_URL is not set
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "Slack webhook not configured, skipping notification"
            exit 0
          fi

          COMMIT_SHORT="${COMMIT_SHA:0:7}"
          MIGRATION_COUNT=$(find migrations -name "*.sql" 2>/dev/null | wc -l)

          if [ "$MIGRATION_COUNT" -gt 0 ]; then
            curl -X POST "$SLACK_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{
                \"text\": \"‚úÖ D1 Migrations Applied\",
                \"blocks\": [
                  {
                    \"type\": \"section\",
                    \"text\": {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*‚úÖ D1 Migrations Applied Successfully*\"
                    }
                  },
                  {
                    \"type\": \"section\",
                    \"fields\": [
                      {
                        \"type\": \"mrkdwn\",
                        \"text\": \"*Environment:*\n\`${DEPLOY_ENV}\`\"
                      },
                      {
                        \"type\": \"mrkdwn\",
                        \"text\": \"*Migrations:*\n${MIGRATION_COUNT} applied\"
                      },
                      {
                        \"type\": \"mrkdwn\",
                        \"text\": \"*Branch:*\n\`${BRANCH_NAME}\`\"
                      },
                      {
                        \"type\": \"mrkdwn\",
                        \"text\": \"*Commit:*\n\`${COMMIT_SHORT}\`\"
                      }
                    ]
                  }
                ]
              }"
          fi

      - name: Slack Notification - D1 Migration Failure
        if: failure()
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DEPLOY_ENV: ${{ steps.env.outputs.environment }}
          BRANCH_NAME: ${{ github.ref_name }}
          GITHUB_REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # Skip if SLACK_WEBHOOK_URL is not set
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "Slack webhook not configured, skipping notification"
            exit 0
          fi

          MENTION=""
          if [ "$DEPLOY_ENV" == "production" ]; then
            MENTION="<!channel> "
          fi

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"üö® ${MENTION}D1 Migration Failed\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"üö® D1 Migration Failed\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Environment:*\n\`${DEPLOY_ENV}\`\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Branch:*\n\`${BRANCH_NAME}\`\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"‚ö†Ô∏è *Action Required:* Database schema may be incomplete.\"
                  }
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {
                      \"type\": \"button\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"View Logs\"
                      },
                      \"url\": \"https://github.com/${GITHUB_REPO}/actions/runs/${RUN_ID}\"
                    }
                  ]
                }
              ]
            }"

      - name: Migration Summary
        env:
          DEPLOY_ENV: ${{ steps.env.outputs.environment }}
          BRANCH_NAME: ${{ github.ref_name }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          COMMIT_SHORT="${COMMIT_SHA:0:7}"

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üóÑÔ∏è D1 Database Migrations Complete

          **Environment:** \`${DEPLOY_ENV}\`
          **Branch:** \`${BRANCH_NAME}\`
          **Commit:** \`${COMMIT_SHORT}\`

          ### Database Updates:
          - ‚úÖ **D1 Migrations Applied**
            - All pending schema migrations executed
            - Database schema is up to date

          ### Infrastructure Status:
          Infrastructure is provisioned manually and already exists:
          - ‚úÖ KV Namespaces (6): JOB_ANALYSIS_CACHE, SESSIONS, RATE_LIMITS, OAUTH_STATES, EMBEDDINGS_CACHE, AI_GATEWAY_CACHE
          - ‚úÖ R2 Buckets (3): avatars, resumes, exports
          - ‚úÖ Vectorize Index (768-dim, cosine)
          - ‚úÖ AI Gateway (1hr cache, 100 req/min limit)
          - ‚úÖ Workers AI (automatic)

          **Note:** Only D1 migrations run on deployment. Infrastructure provisioning is manual.
          EOF

  # Deploy frontend to Cloudflare Pages
  deploy-frontend:
    name: Deploy Frontend to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: [run-tests, run-migrations]
    timeout-minutes: 10
    environment:
      name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || (github.ref_name == 'develop' && 'development' || (github.ref_name == 'staging' && 'staging' || 'production')) }}
      url: ${{ github.ref_name == 'develop' && 'https://jobmatch-ai-dev.pages.dev' || (github.ref_name == 'staging' && 'https://jobmatch-ai-staging.pages.dev' || 'https://jobmatch-ai-production.pages.dev') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Determine environment
        id: env
        env:
          EVENT_NAME: ${{ github.event_name }}
          WORKFLOW_INPUT_ENV: ${{ github.event.inputs.environment }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          if [ "$EVENT_NAME" == "workflow_dispatch" ]; then
            ENV="$WORKFLOW_INPUT_ENV"
          else
            case "$BRANCH_NAME" in
              develop)
                ENV="development"
                ;;
              staging)
                ENV="staging"
                ;;
              main)
                ENV="production"
                ;;
              *)
                echo "Unknown branch: $BRANCH_NAME"
                exit 1
                ;;
            esac
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT

          # Set project name based on environment
          case "$ENV" in
            development)
              echo "project_name=jobmatch-ai-dev" >> $GITHUB_OUTPUT
              echo "backend_url=https://jobmatch-ai-dev.carl-f-frank.workers.dev" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "project_name=jobmatch-ai-staging" >> $GITHUB_OUTPUT
              echo "backend_url=https://jobmatch-ai-staging.carl-f-frank.workers.dev" >> $GITHUB_OUTPUT
              ;;
            production)
              echo "project_name=jobmatch-ai-production" >> $GITHUB_OUTPUT
              echo "backend_url=https://jobmatch-ai-prod.carl-f-frank.workers.dev" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Build frontend
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          VITE_API_URL: ${{ steps.env.outputs.backend_url }}
          VITE_USE_WORKERS_API: 'true'
          VITE_CLOUDFLARE_PAGES: 'true'
        run: npm run build

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ steps.env.outputs.project_name }}
          directory: dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}

      - name: Deployment summary
        env:
          DEPLOY_ENV: ${{ steps.env.outputs.environment }}
          PROJECT_NAME: ${{ steps.env.outputs.project_name }}
          BRANCH_NAME: ${{ github.ref_name }}
          COMMIT_SHA: ${{ github.sha }}
          BACKEND_URL: ${{ steps.env.outputs.backend_url }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        run: |
          COMMIT_SHORT="${COMMIT_SHA:0:7}"

          case "$DEPLOY_ENV" in
            development)
              FRONTEND_URL="https://jobmatch-ai-dev.pages.dev"
              SUPABASE_BRANCH="development (wpupbucinufbaiphwogc)"
              ;;
            staging)
              FRONTEND_URL="https://jobmatch-ai-staging.pages.dev"
              SUPABASE_BRANCH="staging (wpupbucinufbaiphwogc)"
              ;;
            production)
              FRONTEND_URL="https://jobmatch-ai-production.pages.dev"
              SUPABASE_BRANCH="main (lrzhpnsykasqrousgmdh)"
              ;;
          esac

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üöÄ Cloudflare Pages Deployment Complete

          **Environment:** \`${DEPLOY_ENV}\`
          **Branch:** \`${BRANCH_NAME}\`
          **Commit:** \`${COMMIT_SHORT}\`
          **Project:** \`${PROJECT_NAME}\`

          **Frontend URL:** ${FRONTEND_URL}
          **Backend URL:** ${BACKEND_URL}
          **Supabase Branch:** ${SUPABASE_BRANCH}
          **Supabase URL:** ${SUPABASE_URL}

          ### ‚úÖ Tests Passed
          - Frontend type check ‚úì
          - Frontend linter ‚úì
          - Backend type check ‚úì
          - Backend linter ‚úì
          - Backend unit tests ‚úì
          - Backend integration tests ‚úì

          Deployment propagation may take 1-2 minutes.
          EOF

      - name: Slack Notification - Full Deployment Success
        if: success()
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DEPLOY_ENV: ${{ steps.env.outputs.environment }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          # Skip if SLACK_WEBHOOK_URL is not set
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "Slack webhook not configured, skipping notification"
            exit 0
          fi

          COMMIT_SHORT="${COMMIT_SHA:0:7}"

          case "$DEPLOY_ENV" in
            development)
              FRONTEND_URL="https://jobmatch-ai-dev.pages.dev"
              BACKEND_URL="https://jobmatch-ai-dev.carl-f-frank.workers.dev"
              ;;
            staging)
              FRONTEND_URL="https://jobmatch-ai-staging.pages.dev"
              BACKEND_URL="https://jobmatch-ai-staging.carl-f-frank.workers.dev"
              ;;
            production)
              FRONTEND_URL="https://jobmatch-ai-production.pages.dev"
              BACKEND_URL="https://jobmatch-ai-prod.carl-f-frank.workers.dev"
              ;;
          esac

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"‚úÖ Full Deployment Complete - ${DEPLOY_ENV}\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"‚úÖ Deployment Complete\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Environment:*\n\`${DEPLOY_ENV}\`\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Commit:*\n\`${COMMIT_SHORT}\`\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*URLs:*\n‚Ä¢ Frontend: ${FRONTEND_URL}\n‚Ä¢ Backend: ${BACKEND_URL}\"
                  }
                },
                {
                  \"type\": \"context\",
                  \"elements\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"‚úÖ Tests ‚Ä¢ ‚úÖ Workers ‚Ä¢ ‚úÖ Frontend ‚Ä¢ ‚úÖ D1 Migrations\"
                    }
                  ]
                }
              ]
            }"

  # Deploy backend Workers
  deploy-backend:
    name: Deploy Backend to Cloudflare Workers
    runs-on: ubuntu-latest
    needs: [run-tests, run-migrations]
    timeout-minutes: 10
    environment:
      name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || (github.ref_name == 'develop' && 'development' || (github.ref_name == 'staging' && 'staging' || 'production')) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Determine environment
        id: env
        env:
          EVENT_NAME: ${{ github.event_name }}
          WORKFLOW_INPUT_ENV: ${{ github.event.inputs.environment }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          if [ "$EVENT_NAME" == "workflow_dispatch" ]; then
            ENV="$WORKFLOW_INPUT_ENV"
          else
            case "$BRANCH_NAME" in
              develop)
                ENV="development"
                ;;
              staging)
                ENV="staging"
                ;;
              main)
                ENV="production"
                ;;
              *)
                echo "Unknown branch: $BRANCH_NAME"
                exit 1
                ;;
            esac
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT

      - name: Install dependencies
        working-directory: workers
        run: npm ci

      - name: Deploy to Cloudflare Workers
        working-directory: workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DEPLOY_ENV: ${{ steps.env.outputs.environment }}
        run: npx wrangler deploy --env "$DEPLOY_ENV"

      - name: Deployment summary
        env:
          DEPLOY_ENV: ${{ steps.env.outputs.environment }}
          BRANCH_NAME: ${{ github.ref_name }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          COMMIT_SHORT="${COMMIT_SHA:0:7}"

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üéâ Backend Deployment Complete

          **Environment:** ${DEPLOY_ENV}
          **Branch:** ${BRANCH_NAME}
          **Commit:** ${COMMIT_SHORT}

          Backend Workers deployed successfully!
          EOF

      - name: Slack Notification - Workers Deployment Success
        if: success()
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DEPLOY_ENV: ${{ steps.env.outputs.environment }}
          BRANCH_NAME: ${{ github.ref_name }}
          COMMIT_SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          GITHUB_REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # Skip if SLACK_WEBHOOK_URL is not set
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "Slack webhook not configured, skipping notification"
            exit 0
          fi

          COMMIT_SHORT="${COMMIT_SHA:0:7}"

          # Get commit message safely
          COMMIT_MSG=$(git log -1 --pretty=%B | head -1 | tr -d '\n\r' | cut -c1-100)

          case "$DEPLOY_ENV" in
            development)
              WORKERS_URL="https://jobmatch-ai-dev.carl-f-frank.workers.dev"
              ;;
            staging)
              WORKERS_URL="https://jobmatch-ai-staging.carl-f-frank.workers.dev"
              ;;
            production)
              WORKERS_URL="https://jobmatch-ai-prod.carl-f-frank.workers.dev"
              ;;
          esac

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"üöÄ Workers Deployed to ${DEPLOY_ENV}\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"üöÄ Workers Deployment Successful\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Environment:*\n\`${DEPLOY_ENV}\`\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Author:*\n${ACTOR}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Branch:*\n\`${BRANCH_NAME}\`\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Commit:*\n\`${COMMIT_SHORT}\`\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Message:* ${COMMIT_MSG}\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Workers URL:*\n${WORKERS_URL}\"
                  }
                },
                {
                  \"type\": \"context\",
                  \"elements\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"<https://github.com/${GITHUB_REPO}/actions/runs/${RUN_ID}|View Deployment Logs>\"
                    }
                  ]
                }
              ]
            }"

      - name: Slack Notification - Workers Deployment Failure
        if: failure()
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DEPLOY_ENV: ${{ steps.env.outputs.environment }}
          BRANCH_NAME: ${{ github.ref_name }}
          GITHUB_REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # Skip if SLACK_WEBHOOK_URL is not set
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "Slack webhook not configured, skipping notification"
            exit 0
          fi

          MENTION=""
          if [ "$DEPLOY_ENV" == "production" ]; then
            MENTION="<!channel> "
          fi

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"‚ùå ${MENTION}Workers Deployment Failed\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"‚ùå Workers Deployment Failed\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Environment:*\n\`${DEPLOY_ENV}\`\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Branch:*\n\`${BRANCH_NAME}\`\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"‚ö†Ô∏è *Action Required:* Deployment failed. Check logs immediately.\"
                  }
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {
                      \"type\": \"button\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"View Logs\"
                      },
                      \"url\": \"https://github.com/${GITHUB_REPO}/actions/runs/${RUN_ID}\"
                    }
                  ]
                }
              ]
            }"
