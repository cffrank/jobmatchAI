# Security Vulnerability Resolution - qs Package

**Date**: January 2, 2026
**CVE**: CVE-2025-15284
**GHSA**: GHSA-6rw7-vpxm-498p
**Severity**: High (CVSS 7.5)

---

## Vulnerability Details

### Issue
The `qs` package (used by Express for query string parsing) had a critical security flaw in versions < 6.14.1:

- **Problem**: `arrayLimit` option bypass in bracket notation
- **Attack Vector**: DoS via memory exhaustion
- **Vulnerable Code**: Bracket notation (`a[]=1&a[]=2`) ignored `arrayLimit` protection
- **Impact**: Single malicious request could crash server

### Attack Scenario
```javascript
// Attacker sends:
GET /api/search?filters[]=x&filters[]=x&... (100,000 times)

// Application parses with:
qs.parse(query, { arrayLimit: 100 })

// Result:
// - qs ignores limit, parses all 100,000 elements
// - Server memory exhausted
// - Application crashes or becomes unresponsive
```

---

## Resolution Summary

### Status: ✅ RESOLVED

All instances of the `qs` vulnerability have been patched across the entire repository.

### Actions Taken

1. **Backend** (already fixed in commit 90154c5)
   - Updated `backend/package-lock.json`: qs 6.14.0 → 6.14.1
   - Verification: `npm audit` shows 0 vulnerabilities

2. **Firebase Archive** (fixed in commit f0a29e8)
   - Updated `firebase-archive/functions/package-lock.json`: qs 6.14.0 → 6.14.1
   - Verification: `npm audit` shows 0 vulnerabilities

3. **Dependabot Alerts**
   - Alert #1: Dismissed (fixed)
   - Alert #2: Dismissed (fixed)
   - Current status: 0 open alerts

---

## Verification

### All Directories Audited ✅

```bash
# Frontend (root)
npm audit
# Result: found 0 vulnerabilities ✅

# Backend
cd backend && npm audit
# Result: found 0 vulnerabilities ✅

# Workers
cd workers && npm audit
# Result: found 0 vulnerabilities ✅

# Workers E2E Tests
cd workers/e2e-tests && npm audit
# Result: found 0 vulnerabilities ✅

# Firebase Archive
cd firebase-archive/functions && npm audit
# Result: found 0 vulnerabilities ✅
```

### Package Versions Confirmed

All instances of `qs` package across the repository are now at version **6.14.1** or higher:

```bash
# Check all package-lock.json files
find . -name "package-lock.json" -not -path "*/node_modules/*" -exec grep -l '"qs"' {} \;

# Verify each shows version 6.14.1
grep -h '"version"' */package-lock.json firebase-archive/functions/package-lock.json | grep -A 1 '"qs"'
```

---

## Timeline

| Date | Action | Commit |
|------|--------|--------|
| 2026-01-01 | Backend qs updated to 6.14.1 | 90154c5 |
| 2026-01-02 | Dependabot alerts #1 and #2 dismissed | - |
| 2026-01-02 | Firebase archive qs updated to 6.14.1 | f0a29e8 |
| 2026-01-02 | All vulnerabilities resolved | ✅ |

---

## Security Posture

### Current Status
- ✅ **0 open Dependabot alerts**
- ✅ **0 npm audit vulnerabilities** (frontend, backend, workers, archive)
- ✅ **All qs packages at patched version 6.14.1**
- ✅ **DoS attack vector mitigated**

### Ongoing Monitoring
- Dependabot enabled for automated vulnerability detection
- GitHub Actions security scanning runs on every push
- Weekly manual security audits recommended

---

## Technical Details

### What Changed

**Before (vulnerable)**:
```javascript
// lib/parse.js:159-162 in qs@6.14.0
if (root === '[]' && options.parseArrays) {
    obj = utils.combine([], leaf);  // No arrayLimit check!
}
```

**After (patched)**:
```javascript
// lib/parse.js in qs@6.14.1
if (root === '[]' && options.parseArrays) {
    // Now checks currentArrayLength against arrayLimit
    // Throws RangeError if limit exceeded (when throwOnLimitExceeded is true)
    // Converts to object if limit exceeded (consistent with indexed notation)
    if (currentArrayLength >= options.arrayLimit) {
        obj = options.plainObjects ? { __proto__: null } : {};
        obj[currentArrayLength] = leaf;
    } else {
        obj = utils.combine([], leaf);
    }
}
```

### Impact on Application

**No breaking changes**: The patched version maintains backward compatibility while adding proper security controls.

**Express Applications**: Express uses `qs` internally for query string parsing. The update protects all Express routes automatically.

**API Endpoints**: All API endpoints that parse query strings are now protected against arrayLimit bypass attacks.

---

## Prevention & Best Practices

### 1. Automated Dependency Updates
- ✅ Dependabot enabled (auto-creates PRs for security updates)
- ✅ GitHub Actions security scanning (runs on every push)
- ✅ npm audit in CI/CD pipeline

### 2. Regular Audits
- Weekly: Review Dependabot alerts
- Monthly: Run manual `npm audit` across all directories
- Quarterly: Full security review of dependencies

### 3. Input Validation
Even with patched `qs`, always validate input:
```javascript
// Example: Limit array sizes at application level
app.use((req, res, next) => {
  Object.keys(req.query).forEach(key => {
    if (Array.isArray(req.query[key]) && req.query[key].length > 100) {
      return res.status(400).json({ error: 'Array parameter too large' });
    }
  });
  next();
});
```

### 4. Rate Limiting
DoS protection via rate limiting (already implemented):
- IP-based rate limiting for unauthenticated requests
- User-based rate limiting for authenticated requests
- PostgreSQL-backed (persists across restarts)

---

## Related Documentation

- `docs/CREDENTIAL_ROTATION_POLICY.md` - Security credential management
- `docs/SECURITY_FIXES_SUMMARY.md` - Historical security fixes
- `backend/src/middleware/rateLimiter.ts` - Rate limiting implementation

---

## References

- **CVE**: https://nvd.nist.gov/vuln/detail/CVE-2025-15284
- **GitHub Advisory**: https://github.com/advisories/GHSA-6rw7-vpxm-498p
- **qs Patch Commit**: https://github.com/ljharb/qs/commit/3086902ecf7f088d0d1803887643ac6c03d415b9
- **CVSS Calculator**: https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator

---

## Sign-Off

**Resolved By**: Claude Code (AI Assistant)
**Verified By**: Automated npm audit + GitHub Dependabot
**Date**: January 2, 2026
**Status**: ✅ All vulnerabilities resolved, no open security alerts

---

**Next Security Audit Due**: January 9, 2026 (weekly)
